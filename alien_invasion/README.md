# 项目1　外星人入侵 Alien Invasion
在项目“外星人入侵”中，你将使用Pygame包来开发一款2D游戏。它在玩家每消灭一群向下移动的外星人后，将玩家提高一个等级。等级越高，游戏的节奏越快，难度越大。完成这个项目后，你将获得自己动手使用Pygame开发2D游戏所需的技能。

## 武装飞船
　我们来开发一个名为《外星人入侵》的游戏吧！为此将使用Pygame，这是一组功能强大而有趣的模块，可用于管理图形、动画乃至声音，让你能够更轻松地开发复杂的游戏。通过使用Pygame来处理在屏幕上绘制图像等任务，可将重点放在程序的高级逻辑上。

在本章中，你将安装Pygame，再创建一艘能够根据用户输入左右移动和射击的飞船。在接下来的两章，你将创建一群作为射杀目标的外星人，并改进该游戏：限制可供玩家使用的飞船数，并且添加记分牌。

在开发这款游戏的过程中，你还将学习如何管理包含多个文件的项目。你将重构很多代码并管理文件的内容，以确保项目组织有序以及提高效率。

开发游戏是趣学语言的理想方式。看别人玩你编写的游戏能获得满足感，而编写简单的游戏有助于你明白专业级游戏是怎么编写出来的。在阅读本章的过程中，请动手输入并运行代码，以明白各个代码块对整个游戏所做的贡献，并且尝试不同的值和设置，以对如何改进游戏的交互性有更深入的认识。
### 规划项目
开发大型项目时，制定好规划后再动手编写代码很重要。规划可确保你不偏离轨道，从而提高项目成功的可能性。

下面来编写有关游戏《外星人入侵》的描述，其中虽然没有涵盖这款游戏的所有细节，但能让你清楚地知道该如何动手开发。

>在游戏《外星人入侵》中，玩家控制一艘最初出现在屏幕底部中央的飞船。玩家可以使用箭头键左右移动飞船，还可使用空格键射击。游戏开始时，一群外星人出现在天空中，并向屏幕下方移动。玩家的任务是射杀这些外星人。玩家将所有外星人都消灭干净后，将出现一群新的外星人，其移动速度更快。只要有外星人撞到玩家的飞船或到达屏幕底部，玩家就损失一艘飞船。玩家损失三艘飞船后，游戏结束。

开发的第一个阶段将创建一艘飞船，它可左右移动，并且能在用户按空格键时开火。设置好这种行为后，就可以创建外星人并提高游戏的可玩性了。
### 安装Pygame
开始编码前，先来安装Pygame。可使用pip模块来帮助下载并安装Python包。要安装Pygame，在终端提示符下执行如下命令：
```
$ python3 -m pip install --user pygame
```
### 开始游戏项目
开始开发游戏《外星人入侵》吧。首先要创建一个空的Pygame窗口，供之后用来绘制游戏元素，如飞船和外星人。我们还将让这个游戏响应用户输入，设置背景色，以及加载飞船图像。

#### 创建Pygame窗口及响应用户输入
下面创建一个表示游戏的类，以创建空的Pygame窗口。

#### 设置背景色
Pygame默认创建一个黑色屏幕，这太乏味了。下面来将背景设置为另一种颜色，这是在方法__init__()末尾进行的。

#### 创建设置类
每次给游戏添加新功能时，通常也将引入一些新设置。下面来编写一个名为settings的模块，在其中包含一个名为Settings的类，用于将所有设置都存储在一个地方，以免在代码中到处添加设置。这样，每当需要访问设置时，只需使用一个设置对象。另外，在项目增大时，这使得修改游戏的外观和行为更容易：要修改游戏，只需修改（接下来将创建的）settings.py中的一些值，而无须查找散布在项目中的各种设置。

### 添加飞船图像
下面将飞船加入游戏中。为了在屏幕上绘制玩家的飞船，我们将加载一幅图像，再使用Pygame方法blit()绘制它。

为游戏选择素材时，务必要注意许可。最安全、最不费钱的方式是使用Pixabay等网站提供的免费图形，无须授权许可即可使用并修改。

在游戏中几乎可以使用任何类型的图像文件，但使用位图（.bmp）文件最为简单，因为Pygame默认加载位图。虽然可配置Pygame以使用其他文件类型，但有些文件类型要求你在计算机上安装相应的图像库。大多数图像为.jpg、.png或.gif格式，但可使用Photoshop、GIMP和Paint等工具将其转换为位图。

选择图像时，要特别注意背景色。请尽可能选择背景为透明或纯色的图像，便于使用图像编辑器将其背景替换为任意颜色。图像的背景色与游戏的背景色匹配时，游戏看起来最漂亮。你也可以将游戏的背景色设置成图像的背景色。

#### 创建Ship类
选择用于表示飞船的图像后，需要将其显示到屏幕上。我们创建一个名为ship的模块，其中包含Ship类，负责管理飞船的大部分行为。

#### 在屏幕上绘制飞船
下面更新alien_invasion.py，创建一艘飞船并调用其方法blitme()

### 重构：方法 `_check_events()` 和 `_update_screen()`
在大型项目中，经常需要在添加新代码前重构既有代码。重构旨在简化既有代码的结构，使其更容易扩展。本节将把越来越长的方法run_game()拆分成两个辅助方法（helper method）。辅助方法在类中执行任务，但并非是通过实例调用的。在Python中，辅助方法的名称以单个下划线打头。

如果你开发过大量的游戏，可能早就开始像这样将代码放到不同的方法中了。不过如果你从未开发过这样的项目，可能不知道如何组织代码。这里采用的做法是，先编写可行的代码，等代码越来越复杂时再进行重构，以向你展示真正的开发过程：先编写尽可能简单的代码，等项目越来越复杂后对其进行重构。

对代码进行重构使其更容易扩展后，可以开始处理游戏的动态方面了！

#### 方法_check_events()
我们将把管理事件的代码移到一个名为_check_events()的方法中，以简化run_game()并隔离事件管理循环。通过隔离事件循环，可将事件管理与游戏的其他方面（如更新屏幕）分离。

#### 方法_update_screen()
为进一步简化run_game()，将更新屏幕的代码移到一个名为_update_screen()的方法中。

### 驾驶飞船
下面来让玩家能够左右移动飞船。我们将编写代码，在用户按左或右箭头键时做出响应。我们将首先专注于向右移动，再使用同样的原理来控制向左移动。通过这样做，你将学会如何控制屏幕图像的移动。

#### 响应按键
每当用户按键时，都将在Pygame中注册一个事件。事件都是通过方法pygame.event.get()获取的，因此需要在方法_check_events()中指定要检查哪些类型的事件。每次按键都被注册为一个KEYDOWN事件。

Pygame检测到KEYDOWN事件时，需要检查按下的是否是触发行动的键。例如，如果玩家按下的是右箭头键，就增大飞船的rect.centerx值，将飞船向右移动。

#### 允许持续移动
玩家按住右箭头键不放时，我们希望飞船不断向右移动，直到玩家松开为止。我们将让游戏检测pygame.KEYUP事件，以便知道玩家何时松开右箭头键。然后，结合使用KEYDOWN和KEYUP事件以及一个名为moving_right的标志来实现持续移动。

当标志moving_right为False时，飞船不会移动。玩家按下右箭头键时，我们将该标志设置为True，在玩家松开时将该标志重新设置为False。

飞船的属性都由Ship类控制，因此要给这个类添加一个名为moving_right的属性和一个名为update()的方法。方法update()检查标志moving_right的状态。如果该标志为True，就调整飞船的位置。我们将在while循环中调用这个方法，以调整飞船的位置。

#### 左右移动
现在飞船能够持续向右移动了，添加向左移动的逻辑也很容易。我们将再次修改Ship类和方法_check_events()。

#### 调整飞船的速度
当前，每次执行while循环时，飞船最多移动1像素，但可在Settings类中添加属性ship_speed，用于控制飞船的速度。我们将根据这个属性决定飞船在每次循环时最多移动多远。

#### 限制飞船的活动范围
当前，如果玩家按住箭头键的时间足够长，飞船将飞到屏幕之外，消失得无影无踪。下面来修复这种问题，让飞船到达屏幕边缘后停止移动。

#### 重构_check_events()
随着游戏的开发，方法_check_events()将越来越长。因此将其部分代码放在两个方法中，其中一个处理KEYDOWN事件，另一个处理KEYUP事件

#### 按Q键退出
能够高效地响应按键后，我们来添加另一种退出游戏的方式。当前，每次测试新功能时，都需要单击游戏窗口顶部的X按钮来结束游戏，实在是太麻烦了。因此，我们来添加一个结束游戏的键盘快捷键—— Q键

#### 在全屏模式下运行游戏
Pygame支持全屏模式，你可能会更喜欢在这种模式下而非常规窗口中运行游戏。有些游戏在全屏模式下看起来更舒服，而在macOS系统中用全屏模式运行会提升性能。

### 射击
下面来添加射击功能。我们将编写在玩家按空格键时发射子弹（用小矩形表示）的代码。子弹将在屏幕中向上飞行，抵达屏幕上边缘后消失。

#### 添加子弹设置
首先，更新settings.py，在方法__init__()末尾存储新类Bullet所需的值。

#### 创建Bullet类
下面来创建存储Bullet类的文件bullet.py。Bullet类将负责管理子弹的行为。

#### 将子弹存储到编组中
定义Bullet类和必要的设置后，便可编写代码在玩家每次按空格键时都射出一发子弹了。我们将在AlienInvasion中创建一个编组（group），用于存储所有有效的子弹，以便管理发射出去的所有子弹。这个编组是pygame.sprite.Group类的一个实例。pygame.sprite.Group类似于列表，但提供了有助于开发游戏的额外功能。在主循环中，将使用这个编组在屏幕上绘制子弹以及更新每颗子弹的位置。

#### 开火
在AlienInvasion中，需要修改_check_keydown_events()，以便在玩家按空格键时发射一颗子弹。无须修改_check_keyup_events()，因为玩家松开空格键时什么都不会发生。还需要修改_update_screen()，确保在调用flip()前在屏幕上重绘每颗子弹。

为发射子弹，需要做的工作不少，因此编写一个新方法_fire_bullet()来完成这项任务。

#### 删除消失的子弹
当前，子弹在抵达屏幕顶端后消失，但这仅仅是因为Pygame无法在屏幕外面绘制它们。这些子弹实际上依然存在，其Y坐标为负数且越来越小。这是个问题，因为它们将继续消耗内存和处理能力。

需要将这些消失的子弹删除，否则游戏所做的无谓工作将越来越多，进而变得越来越慢。为此，需要检测表示子弹的rect的bottom属性是否为零。如果是，则表明子弹已飞过屏幕顶端。


#### 限制子弹的数量
很多射击游戏对可同时出现在屏幕上的子弹数量进行了限制，以鼓励玩家有目标地射击。

#### 创建方法_update_bullets()
编写并检查子弹管理代码后，可将其移到一个独立的方法中，确保AlienInvasion类组织有序。为此，创建一个名为_update_bullets()的新方法，并将其放在_update_screen()前面。

